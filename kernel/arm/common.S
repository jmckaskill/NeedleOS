#pragma once
#include "../config.h"

#define MODE_USER 16
#define MODE_IRQ 18
#define MODE_SVC 19
#define MODE_SYS 31
#define FIQ_MASKED 64
#define IRQ_MASKED 128
#define ALL_MASKED (FIQ_MASKED|IRQ_MASKED)
#define MODE_THUMB (1 << 5)
#define SCTLR_THUMB_EXCEPTIONS (1 << 30)
#define BRANCH_TO_THUMB 1

#define PTRSZ 4
#define PTR_SHIFT 2

#define LIST_OFF_FREE 0
#define LIST_OFF_TOP CACHE_SIZE
#define LIST_OFF_END (LIST_OFF_TOP+PTRSZ)
#define LIST_SIZE (CACHE_SIZE*2)

#define GLOBAL_LIST_KERNEL (0)
#define GLOBAL_LIST_USER (1*LIST_SIZE)
#define GLOBAL_LIST_SHARED (2*LIST_SIZE)

#define TASK_OFF_PAGES (0*PTRSZ)
#define TASK_OFF_SHARED (1*PTRSZ)
#define TASK_OFF_PAGE_QUOTA (2*PTRSZ)
#define TASK_OFF_PAGE_COUNT (3*PTRSZ)

#define DESC_OFF_NEXT (0*PTRSZ)
#define DESC_OFF_PREV (1*PTRSZ)
#define DESC_OFF_TASK (2*PTRSZ)
#define DESC_SHIFT CACHE_SHIFT
#define DESC_SIZE CACHE_SIZE

#define CORE_OFF_RUNNING_TASK (0*PTRSZ)
#define CORE_OFF_USER_FIRST (1*PTRSZ)
#define CORE_OFF_USER_LAST (2*PTRSZ)
#define CORE_OFF_USER_COUNT (3*PTRSZ)
#define CORE_OFF_SHARED_FIRST (4*PTRSZ)
#define CORE_OFF_SHARED_LAST (5*PTRSZ)
#define CORE_OFF_SHARED_COUNT (6*PTRSZ)

#define PGSZ 4096
#define SEGMENT (16*1024*1024)
#define PAGE_SHIFT 14 // 4 KB

#define TASK_SIZE PGSZ

#define NDL_EINVAL -1
#define NDL_ENOSVC -2
#define NDL_ENOMEM -3

#define ALIGN(SZ, X) (((X) + (SZ) - 1) &~ (SZ))

#define GLOBAL_DATA FAST_MEM
#define CORE_DATA (GLOBAL_DATA + PGSZ)

#define KERNEL_DESC MAIN_MEM
#define USER_DESC (KERNEL_DESC + (NUM_KERNEL*DESC_SIZE))
#define USER_DESC_END (USER_DESC + (NUM_USER*DESC_SIZE))
#define SHARED_DESC USER_DESC_END
#define DESC_END (SHARED_DESC + (NUM_SHARED*DESC_SIZE))

#define KERNEL_HEAP ALIGN(PGSZ, SHARED_DESC)
#define USER_HEAP (KERNEL_HEAP + (NUM_KERNEL*PGSZ))
#define SHARED_HEAP (USER_HEAP + (NUM_USER*PGSZ))
#define HEAP_END (SHARED_HEAP + (NUM_SHARED*PGSZ))

#define IRQ_STACK_TOP STACK_TOP
#define MAIN_STACK_TOP (STACK_TOP - PGSZ)

.global _start
.global main
.global init_board



